services:
  valkey-cluster:
    image: valkey/valkey:latest
    container_name: valkey-cluster
    ports:
      - "7200-7202:7200-7202"
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        for port in 7200 7201 7202; do
          mkdir -p /data/$$port
          cat > /data/$$port/valkey.conf <<CONF
        port $$port
        cluster-enabled yes
        cluster-config-file /data/$$port/nodes.conf
        cluster-node-timeout 5000
        appendonly yes
        bind 0.0.0.0
        protected-mode no
        CONF
          valkey-server /data/$$port/valkey.conf --daemonize yes
        done

        echo "Waiting for nodes to start..."
        sleep 5
        for port in 7200 7201 7202; do
          until valkey-cli -p $$port ping | grep -q PONG; do
            echo "Waiting for port $$port..."
            sleep 1
          done
          echo "Port $$port is ready"
        done

        echo "Creating cluster..."
        echo "yes" | valkey-cli --cluster create \
          127.0.0.1:7200 \
          127.0.0.1:7201 \
          127.0.0.1:7202 \
          --cluster-replicas 0
        echo "Cluster created"
        valkey-cli -p 7200 cluster info

        # Keep the container running
        tail -f /dev/null
    restart: "no"
