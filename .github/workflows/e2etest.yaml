name: End-to-end tests

on:
  workflow_call:
    inputs:
      cache-platform:
        required: true
        type: string
        description: 'Redis or Valkey'
      cache-version:
        required: false
        type: string
        default: '6'
        description: 'version of the cache'
      cache-host:
        required: false
        type: string
        default: '127.0.0.1'
        description: 'host of the cache'
      cache-port:
        required: false
        type: number
        default: 7100
        description: 'port of the cache'
      cache-hit-rate:
        required: false
        type: number
        default: 0.5
        description: 'hit rate of the cache'
      cache-ssl:
        required: false
        type: boolean
        default: false
        description: 'True or False'
      loadtest-duration:
        required: false
        type: number
        default: 30
        description: 'duration of the load test'
      cache-mode:
        required: false
        type: string
        default: 'cluster'
        description: 'cluster or standalone'

jobs:
  e2etest-cache:
    runs-on: ubuntu-24.04
    permissions:
      packages: write
      contents: read
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Set up Docker Compose
        run: sudo apt-get update && sudo apt-get install -y docker-compose

      - name: Set up Python
        uses: actions/setup-python@v6.0.0
        with:
          python-version: '3.13'

      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: latest
          virtualenvs-create: true
          virtualenvs-in-project: true

      - name: Load cached venv
        id: cached-poetry-dependencies
        uses: actions/cache@v4
        with:
          path: .venv
          key: venv-${{ runner.os }}-${{ steps.setup-python.outputs.python-version }}-${{ hashFiles('**/poetry.lock') }}

      - name: Install dependencies
        if: steps.cached-poetry-dependencies.outputs.cache-hit != 'true'
        run: poetry install --only=main

      - name: Install project
        run: poetry install --only=main

      - name: Start OTel Collector
        run: |
          cat <<'EOF' > /tmp/otel-collector-config.yaml
          receivers:
            otlp:
              protocols:
                grpc:
                  endpoint: 0.0.0.0:4317
          exporters:
            debug:
              verbosity: detailed
          service:
            pipelines:
              traces:
                receivers: [otlp]
                exporters: [debug]
          EOF
          sed -i 's/^          //' /tmp/otel-collector-config.yaml
          docker run -d --name otel-collector \
            -p 4317:4317 \
            -v /tmp/otel-collector-config.yaml:/etc/otelcol/config.yaml \
            otel/opentelemetry-collector:latest
          sleep 5

      - name: Run E2E test for Redis (cluster)
        if: ${{ inputs.cache-platform == 'redis' && inputs.cache-mode == 'cluster' }}
        run: |
          docker-compose -f docker-compose-${{ inputs.cache-platform }}.yml up -d && \
          sleep 60 && \
          poetry run locust_cache_benchmark init \
            ${{ inputs.cache-platform }} \
            -f ${{ inputs.cache-host }} \
            -p ${{ inputs.cache-port }} \
            --ssl ${{ inputs.cache-ssl }} \
            --otel-tracing-enabled true \
            --otel-exporter-endpoint http://localhost:4317 && \
          poetry run locust_cache_benchmark loadtest local \
            ${{ inputs.cache-platform }} \
            -f ${{ inputs.cache-host }} \
            -p ${{ inputs.cache-port }} \
            -r ${{ inputs.cache-hit-rate }} \
            -d ${{ inputs.loadtest-duration }} \
            -c 1 -n 1 -k 1 -t 60 \
            --ssl ${{ inputs.cache-ssl }} \
            --otel-tracing-enabled true \
            --otel-exporter-endpoint http://localhost:4317

      - name: Run E2E test for Valkey (cluster)
        if: ${{ inputs.cache-platform == 'valkey' && inputs.cache-mode == 'cluster' }}
        run: |
          docker-compose -f docker-compose-${{ inputs.cache-platform }}.yml up -d
          echo "Waiting for Valkey cluster initialization..."
          sleep 180
          echo "Checking cluster status..."
          docker logs valkey-node-0 || true
          docker logs valkey-cluster-init || true
          poetry run locust_cache_benchmark init \
            ${{ inputs.cache-platform }} \
            -f ${{ inputs.cache-host }} \
            -p 7200 \
            --ssl ${{ inputs.cache-ssl }} \
            --otel-tracing-enabled true \
            --otel-exporter-endpoint http://localhost:4317
          poetry run locust_cache_benchmark loadtest local \
            ${{ inputs.cache-platform }} \
            -f ${{ inputs.cache-host }} \
            -p 7200 \
            -r ${{ inputs.cache-hit-rate }} \
            -d ${{ inputs.loadtest-duration }} \
            -c 1 -n 1 -k 1 -t 60 \
            --ssl ${{ inputs.cache-ssl }} \
            --otel-tracing-enabled true \
            --otel-exporter-endpoint http://localhost:4317

      - name: Run E2E test for Redis (standalone)
        if: ${{ inputs.cache-platform == 'redis' && inputs.cache-mode == 'standalone' }}
        run: |
          docker-compose -f docker-compose-redis-standalone.yml up -d && \
          sleep 10 && \
          poetry run locust_cache_benchmark init \
            redis-standalone \
            -f ${{ inputs.cache-host }} \
            -p ${{ inputs.cache-port }} \
            --ssl ${{ inputs.cache-ssl }} \
            --otel-tracing-enabled true \
            --otel-exporter-endpoint http://localhost:4317 && \
          poetry run locust_cache_benchmark loadtest local \
            redis-standalone \
            -f ${{ inputs.cache-host }} \
            -p ${{ inputs.cache-port }} \
            -r ${{ inputs.cache-hit-rate }} \
            -d ${{ inputs.loadtest-duration }} \
            -c 1 -n 1 -k 1 -t 60 \
            --ssl ${{ inputs.cache-ssl }} \
            --otel-tracing-enabled true \
            --otel-exporter-endpoint http://localhost:4317

      - name: Run E2E test for Valkey (standalone)
        if: ${{ inputs.cache-platform == 'valkey' && inputs.cache-mode == 'standalone' }}
        run: |
          docker-compose -f docker-compose-valkey-standalone.yml up -d && \
          sleep 10 && \
          poetry run locust_cache_benchmark init \
            valkey-standalone \
            -f ${{ inputs.cache-host }} \
            -p ${{ inputs.cache-port }} \
            --ssl ${{ inputs.cache-ssl }} \
            --otel-tracing-enabled true \
            --otel-exporter-endpoint http://localhost:4317 && \
          poetry run locust_cache_benchmark loadtest local \
            valkey-standalone \
            -f ${{ inputs.cache-host }} \
            -p ${{ inputs.cache-port }} \
            -r ${{ inputs.cache-hit-rate }} \
            -d ${{ inputs.loadtest-duration }} \
            -c 1 -n 1 -k 1 -t 60 \
            --ssl ${{ inputs.cache-ssl }} \
            --otel-tracing-enabled true \
            --otel-exporter-endpoint http://localhost:4317

      - name: Verify OTel spans were exported
        run: |
          SPAN_COUNT=$(docker logs otel-collector 2>&1 | grep -c "Span #" || true)
          echo "Total spans exported: $SPAN_COUNT"
          if [ "$SPAN_COUNT" -eq 0 ]; then
            echo "ERROR: No spans were exported to OTel Collector"
            docker logs otel-collector 2>&1 | tail -50
            exit 1
          fi
          echo "OTel tracing verification passed"

      - name: output test result upload
        uses: actions/upload-artifact@v4
        with:
          name: e2etest-${{ inputs.cache-platform }}-${{ inputs.cache-mode }}
          path: redis_test_results.csv
